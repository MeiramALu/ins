{% extends 'base.html' %}
{% load static %}
{% load i18n %}

{% block extra_css %}
{# Подключаем стили Swiper, если они не подключены глобально #}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
<style>
    /* Доп. стили для главной, если нужны специфичные */
    .swiper-pb-5 {
        padding-bottom: 3rem;
    }
</style>
{% endblock extra_css %}

{% block nav %}
{# Исправленная Hero секция (без черных полос по бокам) #}
<section class="text-white position-relative overflow-hidden"
         style="background: url('{% if settings.hero_image_home %}{{ settings.hero_image_home.url }}{% else %}{% static "assets/img/hero/hero-img-1.webp" %}{% endif %}') no-repeat center center; background-size: cover;">

  {# Оверлей на всю ширину #}
  <div class="position-absolute top-0 start-0 w-100 h-100" style="background-color: rgba(13, 22, 46, 0.85);"></div>

  <div class="container position-relative py-5 text-center">
    <div class="row justify-content-center py-5">
        <div class="col-lg-10 col-md-11 py-5" data-aos="zoom-in">
            <h1 class="display-3 fw-bolder mb-4 text-shadow">{{ settings.hero_title_home }}</h1>
            <p class="fs-5 mb-5 text-light text-shadow">{{ settings.hero_subtitle_home }}</p>
            <a href="{% url 'how' %}" role="button" class="btn btn-primary btn-lg rounded-pill px-5 py-3 fw-bold transition-transform hover-lift">{% trans "Подробнее" %}</a>
        </div>
    </div>
  </div>
</section>
{% endblock nav %}

{% block main %}

{# --- Секция: О нас (Кратко) --- #}
<section class="py-5 py-xl-8">
  <div class="container">
    <div class="row justify-content-md-center">
      <div class="col-12 text-center mb-5">
        <h3 class="fs-6 text-primary mb-2 text-uppercase">{% trans "О нас" %}</h3>
        <h2 class="display-5 fw-bolder">{% trans "Об институте" %}</h2>
      </div>
    </div>
    <div class="row gy-4 align-items-center">
      <div class="col-12 col-lg-7">
        <div class="card border-0 shadow-lg rounded-4 transition-shadow hover-shadow-lg transition-transform hover-lift-sm">
          <div class="row g-0">
            <div class="col-md-5">
              {% if settings.about_image %}
                <img src="{{ settings.about_image.url }}"
                     class="img-fluid rounded-start-4 w-100 h-100 object-fit-cover"
                     alt="Фото Института" style="min-height: 300px;">
              {% else %}
                <div class="p-5 w-100 h-100 d-flex align-items-center justify-content-center text-white rounded-start-4" style="background-color: #0f172a; min-height: 300px;">
                    Фото<br>Института
                </div>
              {% endif %}
            </div>
            <div class="col-md-7 d-flex flex-column p-4">
              <div class="card-body">
                <h3 class="card-title fw-bold">{% trans "Кто мы такие?" %}</h3>
                <div class="card-text text-secondary mt-3">
                    {{ settings.about_text_intro|safe|truncatewords:40 }}
                </div>
                <a href="{% url 'about' %}" class="btn btn-outline-primary rounded-pill mt-3 btn-sm">{% trans "Узнать больше" %}</a>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-12 col-lg-5">
        <div class="d-flex flex-column gap-4">
          {# Выводим только первые 3 пункта миссии, если их много #}
          {% for item in mission_items|slice:":3" %}
          <div class="d-flex align-items-start p-4 border rounded-4 transition-background hover-bg-white transition-transform hover-lift-sm">
            <div class="me-4 text-primary fs-3">
              <i class="bi {{ item.icon_class }}"></i>
            </div>
            <div>
              <h5 class="fw-bolder mb-1 text-dark">{{ item.name }}</h5>
              <p class="text-secondary mb-0">{{ item.description }}</p>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
</section>

{# --- Секция: Научные проекты / Лаборатории (СЛАЙДЕР) --- #}
<section class="py-5 py-xl-8 bg-light">
  <div class="container mb-5">
    <div class="row justify-content-md-center">
      <div class="col-12 text-center">
        <h3 class="fs-6 text-primary mb-2 text-uppercase">{% trans "Чем мы занимаемся" %}</h3>
        <h2 class="display-5 fw-bolder mb-0">{% trans "Наши научные проекты" %}</h2>
      </div>
    </div>
  </div>

  <div class="container overflow-hidden">
    <div class="swiper projectsSwiper swiper-pb-5">
      <div class="swiper-wrapper">
        {# Здесь используем labs (как в вашем исходнике), либо best_projects, если хотите проекты #}
        {# Если нужны именно Лаборатории в слайдере: #}
        {% for lab in labs %} <div class="swiper-slide">
            <div class="card card-equal-height border-0 shadow-sm rounded-4 overflow-hidden bsb-overlay-hover transition-transform hover-lift card-hover-scale w-100">
              <a href="{% url 'lab_detail' lab_slug=lab.slug %}" class="text-decoration-none">
                <figure class="m-0">
                  <img class="img-fluid bsb-scale bsb-hover-scale-up w-100 object-fit-cover" loading="lazy"
                       src="{% if lab.image %}{{ lab.image.url }}{% else %}https://placehold.co/600x400/0f172a/ffffff?text={{ lab.name|urlencode }}{% endif %}"
                       alt="{{lab.name}}" style="height: 250px;">
                </figure>
              </a>
              <div class="card-body border-top border-4 border-primary text-center p-4 d-flex flex-column">
                <h4 class="fw-bold mb-3">{{lab.name}}</h4>
                <p class="mb-3 text-secondary flex-grow-1 line-clamp-3">{{lab.description|striptags}}</p>
                <div class="mt-auto">
                    <a href="{% url 'lab_detail' lab_slug=lab.slug %}" class="fw-bold text-decoration-none link-secondary hover-link-primary link-animated">
                      {% trans "Подробнее" %}
                      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-right-short" viewBox="0 0 16 16">
                        <path fill-rule="evenodd" d="M4 8a.5.5 0 0 1 .5-.5h5.793L8.146 5.354a.5.5 0 1 1 .708-.708l3 3a.5.5 0 0 1 0 .708l-3 3a.5.5 0 0 1-.708-.708L10.293 8.5H4.5A.5.5 0 0 1 4 8z" />
                      </svg>
                    </a>
                </div>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
      <div class="swiper-pagination"></div>
    </div>
  </div>
</section>

{# --- Секция: Новости и Объявления --- #}
<section class="py-5 py-xl-8">
  <div class="container">
      <div class="row justify-content-md-center">
          <div class="col-12 text-center mb-5">
            <h3 class="fs-6 text-primary mb-2 text-uppercase">{% trans "События" %}</h3>
            <h2 class="display-5 fw-bolder">{% trans "Новости и объявления" %}</h2>
          </div>
      </div>
      <div class="row gy-4">

          {# Левая колонка: Новости (3 штуки) #}
          <div class="col-12 col-lg-8">
              <h3 class="mb-4 fw-bold">{% trans "Последние новости" %}</h3>
              <div class="vstack gap-4">
                  {# view уже должен отдавать 3 новости, но на всякий случай slice #}
                  {% for news in latest_news|slice:":3" %}
                  <div class="card border-0 shadow-sm rounded-4 transition-shadow hover-shadow-lg transition-transform hover-lift-sm card-hover-scale">
                      <div class="row g-0">
                          <div class="col-md-4">
                              <img src="{% if news.image %}{{ news.image.url }}{% else %}https://placehold.co/600x400/334155/ffffff?text={% trans "Новость" %}{% endif %}"
                                   class="img-fluid rounded-start-4 w-100 h-100 object-fit-cover"
                                   style="min-height: 200px;"
                                   alt="{{ news.title }}">
                          </div>
                          <div class="col-md-8">
                              <div class="card-body">
                                  <p class="text-primary small mb-1 fw-bold">{{ news.publish_date|date:"d F, Y" }}</p>
                                  <h5 class="card-title fw-bolder"><a href="{% url 'news_detail' news_slug=news.slug %}" class="text-dark text-decoration-none hover-link-primary">{{ news.title }}</a></h5>
                                  <p class="card-text text-secondary line-clamp-3">{{ news.excerpt|default:news.content|striptags }}</p>
                              </div>
                          </div>
                      </div>
                  </div>
                  {% empty %}
                  <p>{% trans "Пока нет опубликованных новостей." %}</p>
                  {% endfor %}
              </div>
              <div class="mt-4 text-center text-lg-start">
                  <a href="{% url 'news_all' %}" class="btn btn-outline-primary rounded-pill">{% trans "Все новости" %}</a>
              </div>
          </div>

          {# Правая колонка: Объявления (4 штуки) #}
          <div class="col-12 col-lg-4">
              <div class="p-4 rounded-4 bg-light h-100 border border-primary border-4 transition-shadow hover-shadow-lg">
                  <h3 class="mb-4 fw-bold">{% trans "Объявления" %}</h3>
                  <div class="vstack gap-3">
                      {# Здесь мы берем 4 объявления #}
                      {% for ann in latest_announcements|slice:":4" %}
                      <div class="d-flex p-2 rounded-3 transition-background hover-bg-white">
                          <div class="me-3 flex-shrink-0">
                              <div class="d-flex flex-column text-center bg-primary text-white rounded-3 px-3 py-2">
                                  <span class="fw-bolder fs-5">{{ ann.event_date|date:"d" }}</span>
                                  <small>{{ ann.event_date|date:"M" }}</small>
                              </div>
                          </div>
                          <div class="align-self-center">
                              <a href="#" class="text-dark fw-bold text-decoration-none hover-link-primary link-animated">{{ ann.title }}</a>
                          </div>
                      </div>
                      {% if not forloop.last %}<hr class="my-1">{% endif %}
                      {% empty %}
                      <p class="text-secondary small">{% trans "Объявления отсутствуют." %}</p>
                      {% endfor %}
                  </div>
              </div>
          </div>
      </div>
  </div>
</section>

{# --- Секция: Партнеры --- #}
<section class="py-5 bg-white border-top border-secondary border-opacity-10">
    <div class="container">
      <div class="row justify-content-center text-center">
        <div class="col-12 mb-5">
          <h2 class="fw-bolder">{% trans "Наши партнеры" %}</h2>
        </div>
        <div class="col-lg-10">
          <div class="row align-items-center justify-content-center gy-4">
            {% for partner in partners %}
            <div class="col-6 col-sm-4 col-md-2">
              <a href="{{ partner.website_url|default:'#' }}" target="_blank">
                <img src="{% if partner.logo %}{{ partner.logo.url }}{% else %}https://placehold.co/150x75/e2e8f0/64748b?text={{ partner.name|urlencode }}{% endif %}" class="img-fluid transition-opacity opacity-75 hover-opacity-100" alt="{{ partner.name }}">
              </a>
            </div>
            {% empty %}
            <p>{% trans "Список партнеров пуст." %}</p>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
</section>

{% endblock main %}

{# --- JS для инициализации слайдера --- #}
{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function () {

    const commonOptions = {
        loop: true,
        autoplay: {
            delay: 4000,
            disableOnInteraction: false,
        },
        pagination: {
            el: ".swiper-pagination",
            clickable: true,
        },
        spaceBetween: 30,
        grabCursor: true,
    };

    // Слайдер Научных проектов (Лабораторий) на главной
    new Swiper(".projectsSwiper", {
        ...commonOptions,
        slidesPerView: 1,
        breakpoints: {
            640: { slidesPerView: 1 },
            768: { slidesPerView: 2 },
            1024: { slidesPerView: 3 }, // 3 проекта в ряд на ПК
        },
    });
  });
</script>
{% endblock extra_js %}